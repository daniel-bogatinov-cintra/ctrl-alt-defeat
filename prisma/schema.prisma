generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Retro {
  id        String   @id @default(uuid())
  shareId   String   @unique @default(uuid())
  title     String
  teamName  String?
  createdAt DateTime @default(now())
  status                 String   @default("active")
  maxVotesPerParticipant Int      @default(3)
  timerExpiresAt         DateTime?  // For discussion timer

  participants Participant[]
  memes        MemeEntry[]
  lanes        Lane[]
}

model Lane {
  id      String @id @default(uuid())
  retroId String
  retro   Retro  @relation(fields: [retroId], references: [id], onDelete: Cascade)
  title   String
  order   Int
  memes   MemeEntry[]
}

model Participant {
  id          String   @id @default(uuid())
  retroId     String
  retro       Retro    @relation(fields: [retroId], references: [id], onDelete: Cascade)
  displayName String
  avatarColor String?
  createdAt   DateTime @default(now())
  memes       MemeEntry[]
  reactions   Reaction[]
}

model MemeTemplate {
  id          String   @id @default(uuid())
  memegenId   String   @unique
  displayName String
  previewUrl  String
  lines       Int      @default(2)
  createdAt   DateTime @default(now())
}

model MemeEntry {
  id                String   @id @default(uuid())
  retroId           String
  retro             Retro    @relation(fields: [retroId], references: [id], onDelete: Cascade)
  participantId     String
  participant       Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  laneId            String?
  lane              Lane?    @relation(fields: [laneId], references: [id])
  templateId        String
  topText           String?
  bottomText        String?
  generatedImageUrl String
  createdAt         DateTime @default(now())
  
  // JSON string for quick counts (legacy/optimistic)
  reactions         String   @default("{}") 
  
  // Relation for precise tracking
  reactionsList     Reaction[]
}

model Reaction {
  id            String      @id @default(uuid())
  memeId        String
  meme          MemeEntry   @relation(fields: [memeId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  emoji         String
  createdAt     DateTime    @default(now())

  @@unique([memeId, participantId, emoji]) // One emoji type per meme per person? Or just one reaction per meme? 
                                           // User said "amount of votes". Usually 3 votes total.
                                           // Let's assume distinct reactions per meme are allowed, but total count matters.
}
